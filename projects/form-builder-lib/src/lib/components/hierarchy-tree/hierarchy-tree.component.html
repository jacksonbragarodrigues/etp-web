<div class="hierarchy-tree h-100 d-flex flex-column">
  
  <!-- Tree Header -->
  <div class="tree-header p-3 border-bottom">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="mb-0 fw-semibold">
        <i class="bi bi-diagram-3 me-2"></i>
          Hierarquia
      </h6>
      <div class="tree-actions">
        <button
          class="btn btn-outline-secondary btn-sm me-1"
          (click)="expandAll()"
          title="Expand All">
          <i class="bi bi-plus-square"></i>
        </button>
        <button
          class="btn btn-outline-secondary btn-sm"
          (click)="collapseAll()"
          title="Collapse All">
          <i class="bi bi-dash-square"></i>
        </button>
      </div>
    </div>

    <!-- Filtros Accordion -->
    <div class="tree-filters-accordion">
      <div class="accordion accordion-flush">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button
              class="accordion-button"
              [class.collapsed]="!filtersAccordionExpanded"
              type="button"
              (click)="toggleFiltersAccordion()"
              [attr.aria-expanded]="filtersAccordionExpanded">
              <i class="bi bi-funnel me-2"></i>
              <span class="fw-semibold">Filtros</span>
              <span class="ms-2" *ngIf="hasActiveFilters()">
                <span class="badge bg-primary rounded-pill">{{ getActiveFiltersCount() }}</span>
              </span>
            </button>
          </h2>
          <div
            class="accordion-collapse"
            [class.show]="filtersAccordionExpanded"
            [class.collapse]="!filtersAccordionExpanded">
            <div class="accordion-body p-3">

              <!-- Clear filters button -->
              <div class="d-flex justify-content-end mb-3" *ngIf="hasActiveFilters()">
                <button
                  class="btn btn-outline-secondary btn-sm"
                  (click)="clearAllFilters()"
                  title="Limpar todos os filtros">
                  <i class="bi bi-x me-1"></i>
                  Limpar Filtros
                </button>
              </div>

              <div class="row g-2">
                <!-- Preenchimento Obrigatório -->
                <div class="col-6">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="filterRequiredTrue"
                      [(ngModel)]="filterRequiredTrue"
                      (change)="applyFilters()">
                    <label class="form-check-label small" for="filterRequiredTrue">
                      Obrigatório
                    </label>
                  </div>
                </div>

                <!-- Preenchimento Facultativo -->
                <div class="col-6">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="filterRequiredFalse"
                      [(ngModel)]="filterRequiredFalse"
                      (change)="applyFilters()">
                    <label class="form-check-label small" for="filterRequiredFalse">
                      Facultativo
                    </label>
                  </div>
                </div>

                <!-- Lógica Conditional (Mostrar) -->
                <div class="col-6">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="filterConditionalShow"
                      [(ngModel)]="filterConditionalShow"
                      (change)="applyFilters()">
                    <label class="form-check-label small" for="filterConditionalShow">
                      Lógica: Mostrar
                    </label>
                  </div>
                </div>

                <!-- Lógica Conditional (Ocultar) -->
                <div class="col-6">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="filterConditionalHide"
                      [(ngModel)]="filterConditionalHide"
                      (change)="applyFilters()">
                    <label class="form-check-label small" for="filterConditionalHide">
                      Lógica: Ocultar
                    </label>
                  </div>
                </div>
              </div>

              <!-- Contador de resultados -->
              <div class="mt-3" *ngIf="hasActiveFilters()">
                <div class="alert alert-info py-2 px-3 mb-0">
                  <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    {{ getFilteredComponentsCount() }} componente(s) encontrado(s)
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tree Content -->
  <div class="tree-content flex-grow-1 overflow-auto custom-scrollbar p-3">

    <!-- Empty State -->
    <div class="empty-tree text-center py-5" *ngIf="filteredTreeNodes.length === 0 && !hasActiveFilters()">
      <i class="bi bi-diagram-3 display-4 text-muted mb-3" style="opacity: 0.3;"></i>
      <h6 class="text-muted">No Components</h6>
      <p class="text-muted small">
        Add components to the form to see them in the tree view
      </p>
    </div>

    <!-- No Results State (with filters) -->
    <div class="empty-tree text-center py-5" *ngIf="filteredTreeNodes.length === 0 && hasActiveFilters()">
      <i class="bi bi-funnel display-4 text-muted mb-3" style="opacity: 0.3;"></i>
      <h6 class="text-muted">Nenhum componente encontrado</h6>
      <p class="text-muted small">
        Tente ajustar os filtros ou limpar todos os filtros
      </p>
      <button class="btn btn-outline-primary btn-sm" (click)="clearAllFilters()">
        <i class="bi bi-x me-1"></i>
        Limpar Filtros
      </button>
    </div>

    <!-- Tree Nodes -->
    <div class="tree-nodes" *ngIf="filteredTreeNodes.length > 0">
      <ng-container
        *ngTemplateOutlet="nodeTemplate; context: {
          $implicit: filteredTreeNodes,
          level: 0
        }">
      </ng-container>
    </div>
  </div>

  <!-- Tree Help -->
  <div class="tree-help border-top p-3 bg-light">
    <small class="text-muted">
      <strong>Tip:</strong> Click to select, drag to reorder, right-click for actions
    </small>
    <!-- Bootstrap Icons Test -->
    <div class="mt-2">
      <i class="bi bi-trash me-2"></i>
      <i class="bi bi-files me-2"></i>
      <i class="bi bi-plus me-2"></i>
      <span style="font-size: 0.7rem; color: #6c757d;">Icons test</span>
    </div>
  </div>
</div>

<!-- Recursive Node Template -->
<ng-template #nodeTemplate let-nodes let-level="level">
  <div class="tree-level" [style.margin-left.px]="level * 20">
    <div
      *ngFor="let node of nodes; trackBy: trackByNodeId"
      class="tree-node"
      [class.selected]="isNodeSelected(node)"
      [class.dragging]="isNodeDragging(node)"
      [class.drag-over]="isNodeDragOver(node)"
      [class.expanded]="isNodeExpanded(node)"
      [class.has-children]="hasChildren(node)"
      draggable="true"
      (dragstart)="onDragStart($event, node)"
      (dragend)="onDragEnd($event)"
      (dragover)="onDragOver($event, node)"
      (dragleave)="dragOverNode = null"
      (drop)="onDrop($event, node)"
      (click)="onNodeClick(node)">
      
      <!-- Node Content -->
      <div class="node-content">
        
        <!-- Expand/Collapse Button -->
        <button 
          class="expand-btn"
          *ngIf="hasChildren(node)"
          (click)="onToggleExpanded(node, $event)"
          [class.expanded]="isNodeExpanded(node)">
          <i class="bi bi-chevron-right" 
             [class.bi-chevron-down]="isNodeExpanded(node)"></i>
        </button>
        
        <!-- Spacer for nodes without children -->
        <div class="expand-spacer" *ngIf="!hasChildren(node)"></div>
        
        <!-- Node Icon -->
        <div class="node-icon" [style.color]="getNodeTypeColor(node)">
          <i [class]="getNodeIcon(node)"></i>
        </div>
        
        <!-- Node Label -->
        <div class="node-label">
          <span class="label-text">{{ node.label }}</span>
          <!-- <span class="node-type">{{ node.type }}</span> -->
        </div>
        
        <!-- Node Actions -->
        <div class="node-actions">
          
          <!-- Add Child (for container components) -->
          <button 
            class="action-btn"
            *ngIf="canHaveChildren(node)"
            (click)="onAddChildNode(node, $event)"
            title="Add Child Component">
            <i class="bi bi-plus"></i>
          </button>
          
          <!-- Duplicate -->
          <button 
            class="action-btn"
            (click)="onDuplicateNode(node, $event)"
            title="Duplicate Component">
            <i class="bi bi-files"></i>
          </button>
          
          <!-- Delete -->
          <button 
            class="action-btn delete-btn"
            (click)="onDeleteNode(node, $event)"
            title="Delete Component">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
      
      <!-- Selection Indicator -->
      <div class="selection-indicator" *ngIf="isNodeSelected(node)"></div>
      
      <!-- Child Nodes -->
      <div
        class="child-nodes"
        *ngIf="hasChildren(node) && isNodeExpanded(node)">
        <ng-container 
          *ngTemplateOutlet="nodeTemplate; context: { 
            $implicit: node.children, 
            level: level + 1 
          }">
        </ng-container>
      </div>
    </div>
  </div>
</ng-template>
